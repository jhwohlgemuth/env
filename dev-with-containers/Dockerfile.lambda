FROM ghcr.io/jhwohlgemuth/rust:latest

LABEL author="Jason Wohlgemuth"
LABEL org.opencontainers.image.source https://github.com/jhwohlgemuth/env

EXPOSE 1337
EXPOSE 13337
SHELL ["/root/miniconda3/bin/conda", "run", "-n", "base", "/bin/bash", "-c"]
#
# Install OCaml kernel
# Note: Needs to be executed first(?)
#
WORKDIR /root
COPY ./provision/scripts/install_opam.sh .
RUN chmod +x ./install_opam.sh \
    && ./install_opam.sh \
    && rm ./install_opam.sh
WORKDIR /usr/local/share/jupyter/kernels/ocaml
RUN sed -i 's/OCaml default/OCaml/' kernel.json
COPY ./jupyter/logo_ocaml.png logo-64x64.png
#
# Install Coq language and kernel
#
WORKDIR /root
COPY ./provision/scripts/isntall_coq.sh .
RUN chmod +x ./install_coq.sh \
    && ./install_coq.sh \
    && rm ./install_coq.sh
WORKDIR /usr/local/share/jupyter/kernels/coq
COPY ./jupyter/logo_coq.png logo-64x64.png
#
# Install Node.js and Ruby (using asdf)
#
SHELL ["/bin/bash", "-lc"]
RUN . "$(/home/linuxbrew/.linuxbrew/bin/brew --prefix asdf)/libexec/asdf.sh" \
    && asdf plugin add nodejs && asdf plugin add ruby \
    && asdf install nodejs latest && asdf global nodejs latest
# RUN . "$(/home/linuxbrew/.linuxbrew/bin/brew --prefix asdf)/libexec/asdf.sh" \
#     && asdf install ruby latest && asdf global ruby latest
#
# Cleanup
#
WORKDIR /root
SHELL ["/bin/bash", "-c"]
COPY ./provision/scripts/cleanup.sh .
RUN chmod +x ./cleanup.sh \
    && ./cleanup.sh \
    && rm ./cleanup.sh

WORKDIR /root/dev
ENTRYPOINT [ "/init" ]
CMD ["/bin/zsh"]