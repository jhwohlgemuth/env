FROM ghcr.io/jhwohlgemuth/rust:latest

LABEL author="Jason Wohlgemuth"
LABEL org.opencontainers.image.source https://github.com/jhwohlgemuth/env

EXPOSE 1337
EXPOSE 13337
#
# %arguments
#
ARG HOME=/root
ARG OCAML_VERSION=4.14.1
ARG COQ_VERSION=8.18.0
ARG JUPYTER_KERNELS=/usr/local/share/jupyter/kernel
#
# %setup
#
SHELL ["/bin/bash", "-c"]
RUN mkdir -p \
    /tmp/scripts \
    "${HOME}/.config/utop/" \
    "${JUPYTER_KERNELS}/coq" \
    "${JUPYTER_KERNELS}/ocaml"
#
# %files
#
COPY ./config/.utoprc "${HOME}/.utoprc"
COPY ./config/init.ml "${HOME}/.config/utop/init.ml"
COPY ./jupyter/logo_coq.png "${JUPYTER_KERNELS}/coq/logo-64x64.png"
COPY ./jupyter/logo_ocaml.png "${JUPYTER_KERNELS}/ocaml/logo-64x64.png"
COPY ./provision/scripts/install_coq.sh /tmp/scripts/install_coq.sh
COPY ./provision/scripts/install_ocaml.sh /tmp/scripts/install_ocaml.sh
COPY ./provision/scripts/install_provers.sh /tmp/scripts/install_provers.sh
COPY ./provision/scripts/install_aeneas.sh /usr/local/bin/install_aeneas
COPY ./provision/scripts/install_verus.sh /usr/local/bin/install_verus
#
# %post
#
SHELL ["/bin/bash", "-c"]
RUN source "$(/home/linuxbrew/.linuxbrew/bin/brew --prefix asdf)/libexec/asdf.sh" \
    && asdf plugin add nodejs && asdf install nodejs latest && asdf global nodejs latest \
    && apt-get update && apt-get install --no-install-recommends -y \
        apt-utils \
        autoconf \
        jupyter \
        libgmp-dev \
        libzmq5 \
        libzmq3-dev \
        opam \
        pkg-config \
        ruby-full
SHELL ["/root/miniconda3/bin/conda", "run", "-n", "base", "/bin/bash", "-c"]
RUN chmod +x /tmp/scripts/* /usr/local/bin/install_aeneas /usr/local/bin/install_verus \
    && /tmp/scripts/install_ocaml.sh \
    && /tmp/scripts/install_coq.sh \
    && /tmp/scripts/install_provers.sh
#
# Cleanup
#
WORKDIR /root
SHELL ["/bin/bash", "-c"]
RUN cleanup

WORKDIR /root/dev
ENTRYPOINT [ "/init" ]
CMD ["/bin/zsh"]