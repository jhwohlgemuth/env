FROM ghcr.io/jhwohlgemuth/notebook:latest
#
# %labels
#
LABEL author="Jason Wohlgemuth"
LABEL org.opencontainers.image.source=https://github.com/jhwohlgemuth/env
#
# %arguments
#
ARG HOME=/root
#
# %environment
#
EXPOSE 1337
EXPOSE 4873
EXPOSE 8080
EXPOSE 13337
ENV LC_ALL=C.utf8
ENV NODE_OPTIONS="--max-old-space-size=8192"
ENV PATH="${PATH}:${HOME}/bin"
ENV PATH="${PATH}:${HOME}/.nix-profile/bin"
ENV PATH="${PATH}:${HOME}/.npm-packages/bin"
#
# %setup
#
RUN mkdir -p \
    /tmp/scripts/ \
    /etc/nixos/ \
    /verdaccio/conf/ \
    /etc/services.d/verdaccio/ \
    /verdaccio/conf \
    /verdaccio/plugins \
    /verdaccio/storage
#
# %files
#
COPY ./provision/scripts/web/manifest.nix /tmp/scripts/
COPY ./verdaccio/.npmrc "${HOME}/.npmrc"
COPY ./verdaccio/config.yml /verdaccio/conf/
COPY ./verdaccio/service/* /etc/services.d/verdaccio/
#
# %post
#
SHELL ["/bin/bash", "-c"]
RUN nix-env -iA \
        nixpkgs.bun \
        nixpkgs.htmlq \
        nixpkgs.nodejs_20 \
        nixpkgs.elmPackages.elm \
    && npm install --registry=https://registry.npmjs.org/ --omit=dev --location=global \
        verdaccio@next \
        rescript@^10.1.4 \
        esy@^0.7.2 \
    && curl -sSL https://get.wasp-lang.dev/installer.sh | sh \
    && chmod +x /etc/services.d/verdaccio/run /etc/services.d/verdaccio/finish
#
# %startscript
#
WORKDIR /root/dev
ENTRYPOINT [ "/init" ]
CMD ["/bin/zsh"]